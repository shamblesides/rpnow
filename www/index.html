<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="The Dead-Simple Text-Based Roleplay Website">
  <title>RPNow</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link href="splashscreens/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
  <link href="splashscreens/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
  <link href="splashscreens/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
  <link href="splashscreens/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link href="splashscreens/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
  <link rel="manifest" href="/webmanifest.webmanifest">
  <style>
    body {
      width: 90%;
      max-width: 700px;
      margin: 20px auto;
      box-sizing: border-box;
      text-align: center;
    }
    header aside {
      transform: translate(calc(-20vmin - 32px)) rotate(-10deg);
      text-align: center;
      margin-bottom: 0;
      font-size: calc(16px + 7vmin);
      line-height: 1;
      font-family: "Alice";
    }
    header h1 {
      margin: -2vmin 0 0;
      text-align: center;
      font-size: calc(24px + 14vmin);
      line-height: 1;
      font-family: "Playfair Display";
      font-weight: normal;
    }
    body > div > p {
      text-align: center;
    }
    details {
      text-align: left;
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
      vertical-align: top;
    }
    summary {
      padding: 15px;
    }
    .rp-list {
      text-align: left;
      padding: 0;
    }
    .rp-list li {
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
    }
    .rp-list h3 {
      line-height: 1;
      margin: 0;
      padding: 15px;
    }
    .rp-list a {
      color: inherit;
    }
    summary h2, summary h3 {
      display: inline-block;
      margin: 0;
      line-height: 1;
    }
    summary a {
      color: inherit;
      border-bottom: dotted 1px;
      border-bottom-color: inherit;
    }
    #top-buttons {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    #top-buttons details {
      width: 49%;
    }
    #top-buttons details > :not(summary) {
      margin-left: 20px;
      margin-right: 20px;
    }
    #top-buttons details[open] summary {
      margin-bottom: 10px;
    }
    #top-buttons details > :last-child {
      margin-bottom: 20px;
    }
    #auth-view ul {
      text-align: left;
      display: inline-block;
      width: 150px;
    }
    aside.error {
      display: block;
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      margin: auto;
      max-width: 300px;
      padding: 20px;
      color: white;
      background-color: orange;
      z-index: 35;
    }
    aside.error:empty {
      display: none;
    }
  </style>
</head>

<body>
  <header title="Let's RPNow">
    <aside>Let's</aside>
    <h1>RPNow</h1>
  </header>

  <aside class="error">JavaScript is required for this page to work!</aside>
  <script>document.querySelector('aside.error').innerText = ''</script>
  
  <div id="loading-view">Loading...</div>

  <div id="auth-view" style="display:none">
    <p>The Dead-Simple Text-Based Roleplay Website</p>

    <ul>
      <li>
        <a href="/login.html?signUp">Create account</a>
      </li>
      <li>
        <a href="/login.html">Log in</a>
      </li>
    </ul>
  </div>

  <div id="dashboard-view" style="display:none">
    <form style="margin: 20px 0">
      You are logged in as <a href="user.html" id="username"></a>.
      <input type="submit" formmethod="post" formaction="/logout.lua" value="Log out">
    </form>

    <div id="top-buttons">
      <details>
        <summary>
          <h2>Create RP</h2>
        </summary>

        <form action="new_rp.lua" method="post">
          <input type="submit" value="Start from scratch">
        </form>

        <p>or import a .json file:</p>

        <input type="file" name="file" accept=".json" required onchange="importRP(event)">
      </details>

      <details>
        <summary>
          <h2>Join RP</h2>
        </summary>

        <span>Here's how it works:</span>

        <ol>
          <li>Add your friend's username to the "Accepting invitations from" list below</li>
          <li>Your friend creates an RP</li>
          <li>Your friend invites you to the RP</li>
          <li>
            If they have never invited you to an RP before, you will need to give them your verification code:
            <button onclick="showVerificationCode()">Get Verification Code</button>
          </li>
          <li>You refresh this page, and the RP will be here</li>
        </ol>
      </details>
    </div>

    <section>
      You are accepting invitations from:
      <ul id="friend-list" style="margin:auto; width:fit-content; text-align: left;">
        <li>
          <form onsubmit="addFriend(event)">
            <input type="text" name="friend" placeholder="Friend's username">
            <button type="submit">Add</button>
          </form>
        </li>
      </ul>
    </section>

    <h2>My RPs</h2>
    <ul id="rp-list" class="rp-list"></ul>
    <div id="db-loading">Loading RP list...</div>
    
    <details id="hidden-rps" style="display: none; border: none">
      <summary><b>Hidden RPs</b></summary>
      <ul id="hidden-rp-list" class="rp-list"></ul>
    </div>
  </div>

  <template id="tile-template">
    <li>
      <a>
        <button class="hide-button" style="float:right">Hide</button>
        <h3>Loading...</h3>
      </a>
    </li>
  </template>

  <script>
    function setError(error) {
      document.querySelector('aside.error').innerText = (error.reason || error || '').toString();
    }
    window.onerror = setError
    window.onunhandledrejection = setError
  </script>

  <script>
    // service worker support - should be on index, rp page, and maybe others later
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('notification-sw.js')
    }
  </script>

  <!-- application code -->
  <script type="text/javascript">
    function ok (response) {
      if (response.status <= 299) {
        return response;
      } else {
        return response.text().then(function (text) {
          var err = new Error(text);
          err.code = response.status;
          throw err;
        })
      }
    }
    function onreject (err) {
      setError(err);
      throw err;
    }
    var loadingView = document.getElementById('loading-view');
    var dashboardView = document.getElementById('dashboard-view')
    var authView = document.getElementById('auth-view');

    fetch('/dashboard.lua')
    .then(ok)
    .then(function (res) {return res.json()})
    .then(showDashboard)
    .catch(function (err) {
      if (err.code === 401) {
        showAuth();
      } else {
        throw err;
      }
    })
    .catch(onreject)

    function showAuth() {
      dashboardView.style.display = 'none'
      loadingView.style.display = 'none'
      authView.style.display = ''
    }

    function showDashboard(user) {
      authView.style.display = 'none'
      loadingView.style.display = 'none';
      dashboardView.style.display = ''

      document.getElementById('username').innerText = user.username
      document.getElementById('rp-list').innerText = ''
      document.getElementById('db-loading').style.display = 'block'

      user.friends.forEach(function (friendUsername) {
        var li = document.createElement('li')
        li.style.position = 'relative'
        li.innerText = friendUsername
        var x = document.createElement('button')
        x.type = 'button'
        x.innerText = 'X'
        x.style.position = 'absolute'
        x.style.right = '0'
        x.onclick = removeFriend.bind(null, friendUsername)
        li.appendChild(x)
        var friendList = document.getElementById('friend-list')
        friendList.insertBefore(li, friendList.lastElementChild)
      })

      var template = document.querySelector('template#tile-template');
      if (user.rooms.length === 0) {
        document.getElementById('rp-list').innerText = "You haven't created or joined any RP yet"
      }
      user.rooms.forEach(function (info) {
        var el = template.content.cloneNode(true).querySelector('*');
        el.querySelector('a').href = `/rp.html?room=${info.id}`;
        Object.assign(el.style, colorsForString(info.title + info.id))
        var h3 = el.querySelector('h3');
        h3.innerText = info.title;
        var hideButton = el.querySelector('.hide-button');
        function hide(event) {
          if (event) {
            event.preventDefault()
            document.getElementById('rp-list').removeChild(el);
            fetch('/dashboard/hide?room='+info.id, {method:'POST'});
          }
          document.getElementById('hidden-rps').style.display = '';
          document.getElementById('hidden-rp-list').appendChild(el);
          hideButton.innerText = 'Unhide'
          hideButton.onclick = show
        }
        function show(event) {
          if (event) {
            event.preventDefault()
            document.getElementById('hidden-rp-list').removeChild(el);
            fetch('/dashboard/show?room='+info.id, {method:'POST'});
          }
          document.getElementById('rp-list').appendChild(el);
          hideButton.innerText = 'Hide'
          hideButton.onclick = hide
        }
        if (info.hidden) {
          hide()
        } else {
          show()
        }
      });

      document.getElementById('db-loading').style.display = 'none';
    }

    function addFriend(event) {
      event.preventDefault()
      var friendUsername = event.target.elements.friend.value;
      event.target.elements.friend.value = '';

      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      userbase.insertItem({ databaseName: 'trusted-inviters', itemId: friendUsername, item: true })
      .then(function () {
        location.reload()
      }).catch(function (err) {
        dashboardView.style.display = '';
        loadingView.style.display = 'none';
        if (err.name === 'ItemAlreadyExists') {
          alert(`Already accepting invites from ${friendUsername}`)
        } else {
          throw err
        }
      })
      .catch(onreject)
    }

    function removeFriend(friendUsername) {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      userbase.deleteItem({ databaseName: 'trusted-inviters', itemId: friendUsername })
      .then(function () {
        location.reload()
      }).catch(function (err) {
        dashboardView.style.display = '';
        loadingView.style.display = 'none';
        throw err
      }).catch(onreject)
    }

    function importRP(event) {
      var file = event.target.files[0]
      event.target.value = '';

      dashboardView.style.display = 'none';
      loadingView.style.display = '';
      var meter = document.createElement('meter');
      loadingView.appendChild(meter)
      var progressDiv = document.createElement('div');
      loadingView.appendChild(progressDiv)

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return new Promise(function (resolve) {
          var fr = new FileReader();
          fr.onload = function(evt) {
            resolve(this.result)
          }
          fr.readAsText(file);
        })
      })
      .then(function (json) {
        var messages = JSON.parse(json);
        var meta = messages.shift();
        console.log(meta);
        console.log(messages);
        var charaIds = [];
        var idCounter = 1;
        var totalCount = messages.length + meta.charas.length;
        var progress = 0;
        function wait(value) {
          return new Promise(function (resolve) { setTimeout(resolve, 1000, value) })
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: meta.title,
        }).then(function insertCharas() {
          var batch = meta.charas.slice(0, 10).map(function (data) {
            return { name: data.name, color: data.color, timestampOverride: data.timestamp };
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `c-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (item, i) {
              console.log(`${batchIds[i]}   ${item.name}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: item
              }
            })
          })
          .then(function () {
            progress += batch.length;
            progressDiv.innerText = `Importing data... (${progress/10|0} / ${totalCount/10|0})`;
            meter.value = progress / totalCount;
            meta.charas.splice(0, 10);
            charaIds = charaIds.concat(batchIds);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertCharas)
        }).then(function insertMessages() {
          var batch = messages.slice(0, 10).map(function (data) {
            return (data.type === 'image') ? {
              type: 'image',
              url: data.url,
              timestampOverride: data.timestamp,
            } : {
              type: 'text',
              who: ['narrator','ooc'].includes(data.type) ? data.type : charaIds[data.charaId],
              content: data.content,
              timestampOverride: data.timestamp,
            }
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `m-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (msg, i) {
              console.log(`${batchIds[i]}   ${msg.type} ${msg.who}    ${msg.content || msg.url}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: msg
              }
            })
          })
          .then(function () {
            progress += batch.length;
            progressDiv.innerText = `Importing data... (${progress/10|0} / ${totalCount/10|0})`;
            meter.value = progress / totalCount;
            messages.splice(0, 10);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertMessages)
        })
      })
      .then(function () {
        return userbase.getDatabases({ databaseName: rpid })
      })
      .then(function (result) {
        var room = result.databases[0].databaseId
        window.location.href = `/rp.html?room=${room}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function showVerificationCode() {
      userbase.getVerificationMessage()
      .then(function (result) {
        console.log(result)
        prompt('Copy this code and send it to your friend.', result.verificationMessage);
      })
      .catch(function (err) {
        alert(err);
      })
    }

    function djb2(str){
      var hash = 5381;
      for (var i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
      }
      return hash;
    }

    function colorsForString(str) {
      // hash id into 32-bit integer
      var hash = djb2(str.split('').reverse().join(''));

      var rgb = [0,8,16].map(function (shift) {
        return hash >> shift & 255;
      })
      var r = rgb[0];
      var g = rgb[1];
      var b = rgb[2];

      var light = (r*299)+(g*587)+(b*114) > 128000;

      return {
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        color: light? 'black':'white'
      }
    }
  </script>
</body>
</html>
