<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>RPNow</title>
  <style>
    body {
      width: 90%;
      max-width: 700px;
      margin: 20px auto;
      box-sizing: border-box;
      text-align: center;
    }
    header aside {
      transform: translate(calc(-20vmin - 32px)) rotate(-10deg);
      text-align: center;
      margin-bottom: 0;
      font-size: calc(16px + 7vmin);
      line-height: 1;
      font-family: "Alice";
    }
    header h1 {
      margin: -2vmin 0 0;
      text-align: center;
      font-size: calc(24px + 14vmin);
      line-height: 1;
      font-family: "Playfair Display";
      font-weight: normal;
    }
    body > div > p {
      text-align: center;
    }
    details {
      text-align: left;
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
      vertical-align: top;
    }
    summary {
      padding: 15px;
    }
    .rp-list {
      text-align: left;
      padding: 0;
    }
    .rp-list li {
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
    }
    .rp-list h3 {
      line-height: 1;
      margin: 0;
      padding: 15px;
    }
    .rp-list a {
      color: inherit;
    }
    summary h2, summary h3 {
      display: inline-block;
      margin: 0;
      line-height: 1;
    }
    summary a {
      color: inherit;
      border-bottom: dotted 1px;
      border-bottom-color: inherit;
    }
    #top-buttons {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    #top-buttons details {
      width: 49%;
    }
    #top-buttons details > :not(summary) {
      margin-left: 20px;
      margin-right: 20px;
    }
    #top-buttons details[open] summary {
      margin-bottom: 10px;
    }
    #top-buttons details > :last-child {
      margin-bottom: 20px;
    }
    #auth-view ul {
      text-align: left;
      display: inline-block;
      width: 150px;
    }
  </style>
</head>

<body>
  <header title="Let's RPNow">
    <aside>Let's</aside>
    <h1>RPNow</h1>
  </header>

  <div id="loading-view">Loading...</div>

  <div id="auth-view" style="display:none">
    <p>The Dead-Simple Text-Based Roleplay Website</p>

    <ul>
      <li>
        <a href="/login.html?signUp">Create account</a>
      </li>
      <li>
        <a href="/login.html">Log in</a>
      </li>
    </ul>
  </div>

  <div id="dashboard-view" style="display:none">
    <p>
      You are logged in as <a href="user.html" id="username"></a>.
      <button type="button" onclick="handleLogout()">Log out</button>
      <div id="logout-error"></div>
    </p>

    <div id="top-buttons">
      <details>
        <summary>
          <h2>Create RP</h2>
        </summary>

        <button onclick="createRP()">
          Start from scratch
        </button>

        <p>or import a .json file:</p>

        <input type="file" name="file" accept=".json" required onchange="importRP(event)">
      </details>

      <details>
        <summary>
          <h2>Join RP</h2>
        </summary>

        <span>Here's how it works:</span>

        <ol>
          <li>Add your friend's username to the "Accepting invitations from" list below</li>
          <li>Your friend creates an RP</li>
          <li>Your friend invites you to the RP</li>
          <li>
            If they have never invited you to an RP before, you will need to give them your verification code:
            <button onclick="showVerificationCode()">Get Verification Code</button>
          </li>
          <li>You refresh this page, and the RP will be here</li>
        </ol>
      </details>
    </div>

    <section>
      You are accepting invitations from:
      <ul id="friend-list" style="margin:auto; width:fit-content; text-align: left;">
        <li>
          <form onsubmit="addFriend(event)">
            <input type="text" name="friend" placeholder="Friend's username">
            <button type="submit">Add</button>
          </form>
        </li>
      </ul>
    </section>

    <h2>My RPs</h2>
    <ul id="rp-list" class="rp-list"></ul>
    <div id="db-loading">Loading RP list...</div>
    <div id="db-error"></div>
    
    <details id="hidden-rps" style="display: none; border: none">
      <summary><b>Hidden RPs</b></summary>
      <ul id="hidden-rp-list" class="rp-list"></ul>
    </div>
  </div>

  <template id="tile-template">
    <li>
      <a>
        <button class="hide-button" style="float:right">Hide</button>
        <h3>Loading...</h3>
      </a>
    </li>
  </template>

  <!-- application code -->
  <script type="text/javascript" src="https://sdk.userbase.com/2/userbase.js?uncache=1"></script>
  <script type="text/javascript">
    var loadingView = document.getElementById('loading-view');
    var dashboardView = document.getElementById('dashboard-view')
    var authView = document.getElementById('auth-view');

    userbase.init({
      appId: '630241a7-b753-44d0-a7de-358fe646cc27',
      sessionLength: 365 * 24,
    })
    .then(function (session) {
      if (session.user) {
        showDashboard(session.user);
      } else {
        showAuth();
      }
    })

    function showAuth() {
      dashboardView.style.display = 'none'
      loadingView.style.display = 'none'
      authView.style.display = ''
    }

    function handleLogout() {
      userbase.signOut().then(function () {
        showAuth();
      }).catch(function (err) {
        document.getElementById('logout-error').innerText = err;
      });
    }

    var friendDbOpenPromise
    var friendHash = {}

    function showDashboard(user) {
      authView.style.display = 'none'
      loadingView.style.display = 'none';
      dashboardView.style.display = ''

      document.getElementById('username').innerText = user.username
      document.getElementById('rp-list').innerText = ''
      document.getElementById('db-loading').style.display = 'block'
      document.getElementById('db-error').innerText = ''

      friendDbOpenPromise = userbase.openDatabase({
        databaseName: 'trusted-inviters',
        changeHandler(changes) {
          changes.forEach(function (change) {
            var friendUsername = change.itemId
            friendHash[friendUsername] = true
            var li = document.createElement('li')
            li.style.position = 'relative'
            li.innerText = friendUsername
            var x = document.createElement('button')
            x.type = 'button'
            x.innerText = 'X'
            x.style.position = 'absolute'
            x.style.right = '0'
            x.onclick = removeFriend.bind(null, friendUsername)
            li.appendChild(x)
            var friendList = document.getElementById('friend-list')
            friendList.insertBefore(li, friendList.lastElementChild)
          })
        }
      })

      var metaInfo = {}
      var metaDbOpenPromise = userbase.openDatabase({
        databaseName: 'dashboard-cache',
        changeHandler(changes) {
          changes.forEach(function (change) {
            metaInfo[change.itemId] = change.item
          })
          console.log(metaInfo)
        }
      })

      userbase.getDatabases()
        .then(function (results) {
          console.log(results);
          var roomInfos = []
          return friendDbOpenPromise.then(function () {
            results.databases.forEach(function (databaseMeta) {
              if (!databaseMeta.databaseName.startsWith('rp-')) {
                return
              }
              if (!databaseMeta.isOwner) {
                var ownerUser = databaseMeta.users.find(function (user) { return user.isOwner === true })
                if (!friendHash[ownerUser.username]) return
              }
              var id = databaseMeta.isOwner ? databaseMeta.databaseName : databaseMeta.databaseId;
              var colors = colorsForString(databaseMeta.databaseName)
              roomInfos.push({ id: id, colors: colors })
            })
            return roomInfos
          })
        }).then(function (roomInfos) {
          var template = document.querySelector('template#tile-template');
          if (roomInfos.length === 0) {
            document.getElementById('rp-list').innerText = "You haven't created or joined any RP yet"
          }
          roomInfos.forEach(function (info) {
            var el = template.content.cloneNode(true).querySelector('*');
            el.querySelector('a').href = `/rp.html?room=${info.id}`;
            Object.assign(el.style, info.colors)
            var h3 = el.querySelector('h3');
            metaDbOpenPromise.then(function () {
              var title = (metaInfo[info.id] && metaInfo[info.id] != null) ? metaInfo[info.id].title : '‚ùó Newly added RP'
              var hidden = metaInfo[info.id] && metaInfo[info.id].hidden;
              h3.innerText = title
              var hideButton = el.querySelector('.hide-button');
              function hide(event) {
                if (event) {
                  event.preventDefault()
                  document.getElementById('rp-list').removeChild(el);
                  if (metaInfo[info.id]) {
                    metaInfo[info.id].hidden = true
                    userbase.updateItem({ databaseName: 'dashboard-cache', itemId: info.id, item: metaInfo[info.id] })
                  } else {
                    metaInfo[info.id] = { hidden: true }
                    userbase.insertItem({ databaseName: 'dashboard-cache', itemId: info.id, item: metaInfo[info.id] })
                  }
                }
                document.getElementById('hidden-rps').style.display = '';
                document.getElementById('hidden-rp-list').appendChild(el);
                hideButton.innerText = 'Unhide'
                hideButton.onclick = show
              }
              function show(event) {
                metaInfo = metaInfo || {}
                metaInfo.hidden = false
                if (event) {
                  event.preventDefault()
                  document.getElementById('hidden-rp-list').removeChild(el);
                  metaInfo[info.id].hidden = false
                  userbase.updateItem({ databaseName: 'dashboard-cache', itemId: info.id, item: metaInfo[info.id] })
                }
                document.getElementById('rp-list').appendChild(el);
                hideButton.innerText = 'Hide'
                hideButton.onclick = hide
              }
              if (hidden) {
                hide()
              } else {
                show()
              }
            })
          });
          document.getElementById('db-loading').style.display = 'none';
        })
        .catch(function (err) {
          document.getElementById('db-error').innerText = err
          throw err;
        })
    }

    function addFriend(event) {
      event.preventDefault()
      var friendUsername = event.target.elements.friend.value;
      event.target.elements.friend.value = '';

      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      friendDbOpenPromise.then(function () {
        return userbase.insertItem({ databaseName: 'trusted-inviters', itemId: friendUsername, item: true })
      }).then(function () {
        location.reload()
      }).catch(function (err) {
        dashboardView.style.display = '';
        loadingView.style.display = 'none';
        if (err.name === 'ItemAlreadyExists') {
          alert(`Already accepting invites from ${friendUsername}`)
        } else {
          alert(err.message)
          throw err
        }
      })
    }

    function removeFriend(friendUsername) {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      friendDbOpenPromise.then(function () {
        return userbase.deleteItem({ databaseName: 'trusted-inviters', itemId: friendUsername })
      }).then(function () {
        location.reload()
      }).catch(function (err) {
        dashboardView.style.display = '';
        loadingView.style.display = 'none';
        alert(err.message)
        throw err
      })
    }

    function createRP() {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: 'Untitled',
        });
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function importRP(event) {
      var file = event.target.files[0]
      event.target.value = '';

      dashboardView.style.display = 'none';
      loadingView.style.display = '';
      var meter = document.createElement('meter');
      loadingView.appendChild(meter)
      var progressDiv = document.createElement('div');
      loadingView.appendChild(progressDiv)

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return new Promise(function (resolve) {
          var fr = new FileReader();
          fr.onload = function(evt) {
            resolve(this.result)
          }
          fr.readAsText(file);
        })
      })
      .then(function (json) {
        var messages = JSON.parse(json);
        var meta = messages.shift();
        console.log(meta);
        console.log(messages);
        var charaIds = [];
        var idCounter = 1;
        var totalCount = messages.length + meta.charas.length;
        var progress = 0;
        function wait(value) {
          return new Promise(function (resolve) { setTimeout(resolve, 1000, value) })
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: meta.title,
        }).then(function insertCharas() {
          var batch = meta.charas.slice(0, 10).map(function (data) {
            return { name: data.name, color: data.color, timestampOverride: data.timestamp };
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `c-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (item, i) {
              console.log(`${batchIds[i]}   ${item.name}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: item
              }
            })
          })
          .then(function () {
            progress += batch.length;
            progressDiv.innerText = `Importing data... (${progress/10|0} / ${totalCount/10|0})`;
            meter.value = progress / totalCount;
            meta.charas.splice(0, 10);
            charaIds = charaIds.concat(batchIds);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertCharas)
        }).then(function insertMessages() {
          var batch = messages.slice(0, 10).map(function (data) {
            return (data.type === 'image') ? {
              type: 'image',
              url: data.url,
              timestampOverride: data.timestamp,
            } : {
              type: 'text',
              who: ['narrator','ooc'].includes(data.type) ? data.type : charaIds[data.charaId],
              content: data.content,
              timestampOverride: data.timestamp,
            }
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `m-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (msg, i) {
              console.log(`${batchIds[i]}   ${msg.type} ${msg.who}    ${msg.content || msg.url}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: msg
              }
            })
          })
          .then(function () {
            progress += batch.length;
            progressDiv.innerText = `Importing data... (${progress/10|0} / ${totalCount/10|0})`;
            meter.value = progress / totalCount;
            messages.splice(0, 10);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertMessages)
        })
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function showVerificationCode() {
      userbase.getVerificationMessage()
      .then(function (result) {
        console.log(result)
        prompt('Copy this code and send it to your friend.', result.verificationMessage);
      })
      .catch(function (err) {
        alert(err);
      })
    }

    function djb2(str){
      var hash = 5381;
      for (var i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
      }
      return hash;
    }

    function colorsForString(str) {
      // hash id into 32-bit integer
      var hash = djb2(str.split('').reverse().join(''));

      var rgb = [0,8,16].map(function (shift) {
        return hash >> shift & 255;
      })
      var r = rgb[0];
      var g = rgb[1];
      var b = rgb[2];

      var light = (r*299)+(g*587)+(b*114) > 128000;

      return {
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        color: light? 'black':'white'
      }
    }
  </script>
</body>
</html>
