<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="My RP">
  <title>Loading...</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="custom.css">
</head>

<body>
  <aside class="error">JavaScript is required for this page to work!</aside>
  <script>document.querySelector('aside.error').innerText = ''</script>
  
  <header>
    <h1 id="title"></h1>

    <nav id="pager">
      <a class="icon-button" id="prev-page">‚¨Ö</a>
      <form>
        <select name="page" onchange="this.closest('form').submit()"></select>
      </form>
      <a class="icon-button" id="next-page">‚û°</a>
    </nav>

    <details id="settings">
      <summary>
        Settings
      </summary>
      <div>
        Hello, <span id="my-user-name" class="user-name"></span>
        <button type="button" class="text-button" onclick="openUsernameDialog()">
          Change
        </button>
        <button type="submit" class="text-button" form="logout-form">
          Logout
        </button>
      </div>
      <input type="checkbox" id="audio-alerts" data-persist="audioAlerts"/>
      <label for="audio-alerts">Audio alerts</label>
      <br>
      <input type="checkbox" id="quicksend" data-persist="quicksend"/>
      <label for="quicksend">Quick send</label>
      <br>
      <a href="settings.html" target="_blank">üë∑ RP Settings</a>
    </details>
    <form action="/api/logout" method="POST" style="display:none" id="logout-form"></form>
  </header>
  
  <form id="send-box" class="chara-bg" onsubmit="sendMessage(event)" data-page="chat">
    <input type="hidden" name="type" value="text">
    <select class="change-chara" name="who" onchange="selectSpeaker(this.value)">
      <option value="narrator">üìñ Narrator</option>
      <option value="ooc">üí¨ Out of Character</option>
    </select>
    <a class="icon-button" target="_blank" href="charas.html">üë•</a>
    <button type="button" class="icon-button" onclick="openPopup('image-dialog')">üñºÔ∏è</button>
    <a class="icon-button" target="_blank" href="format.html">üéÄ</a>
    <textarea name="content" rows="3" maxlength="10000" placeholder="Type your message." onkeydown="quicksend(event, true)" oninput="autosizeTextarea(event, 3, 6)" data-persist="sendBoxText"></textarea>
    <button type="submit">‚û§</button>
  </form>
  
  <form id="image-dialog" class="dialog" oninput="this.querySelector('img').src=(this.checkValidity() ? url.value : '')" onreset="this.querySelector('img').src=''" onsubmit="sendImage(event)" data-page="chat">
    <h3>Image Post</h3>
    <input type="hidden" name="type" value="image">
    <input type="hidden" name="_id">
    <input name="url" type="url" ref="urlbox" required placeholder="Enter a URL">
    <img alt="Image preview">
    <button type="submit" class="text-button">Send ‚û§</button>
    <button type="reset" class="text-button" onclick="closeMe(event)">Cancel ‚úò</button>
  </form>
  
  <main>
    <p id="loading-messages" class="notice">
      <span class="emoji">‚è≥</span> Loading messages...
    </p>
    <div id="no-messages" class="notice">
      <h2>Nothing here yet</h2>
      <p>It's time to start writing!</p>
    </div>
  </main>
  
  <div class="dialog-overlay" data-what="dialog" onclick="closePopup(event)"></div>

  <!-- Templates should go below all elements -->
  <!-- (Because of an iOS9 bug!) -->
  <!-- https://stackoverflow.com/questions/60023595 -->

  <template id="msg-text">
    <div class="message chara-bg">
      <button class="history-button" onclick="showHistory(event)">edits</button>
      <button class="edit-button icon-button" onclick="toggleEditing(event)">‚úé</button>
      <div class="chara-name"></div>
      <div class="user-name"></div>
      <blockquote></blockquote>
      <form class="edit-message" onsubmit="sendEditedMessage(event)">
        <input type="hidden" name="_id">
        <input type="hidden" name="type">
        <input type="hidden" name="who">
        <textarea name="content" maxlength="10000" rows="3" onkeydown="quicksend(event)"></textarea>
        <button type="submit" class="text-button">Save ‚ûî</button>
        <button type="reset" class="text-button" onclick="toggleEditing(event)">Cancel ‚úò</button>
      </form>
    </div>
  </template>

  <template id="msg-image">
    <div class="message message-image">
      <button class="history-button" onclick="showHistory(event)">edits</button>
      <button class="edit-button icon-button" onclick="editImage(event)">‚úé</button>
      <img alt="User posted image">
    </div>
  </template>

  <template id="msg-unknown">
    <div class="message">
      <h3>Unknown message type!</h3>
      <dl></dl>
    </div>
  </template>

  <script>
    function setError(error) {
      document.querySelector('aside.error').innerText = (error || '').toString();
    }
    window.onerror = setError
  </script>

  <script>
    function openPopup(id) {
      document.getElementById(id).classList.toggle('open');
      document.getElementById(id).querySelector('button,input,a').focus();
    }
    function closePopup(event) {
      var className = event.target.dataset.what;
      Array.from(document.getElementsByClassName(className))
      .forEach(closeElement);
    }
    function closeMe(event) {
      var el = event.target.closest('.dialog');
      closeElement(el);
    }
    function closeElement(el) {
      if (el && el.classList.contains('open')) {
        if (el.tagName === 'FORM') {
          el.reset();
          // hidden elements, like _id, are not reset automatically
          if (el.elements['_id']) {
            el.elements['_id'].value = '';
          }
        }
        el.classList.remove('open');
      }
    }
    function toggleEditing(event) {
      event.target.closest('.message').classList.toggle('editing');
    }
    function editImage(event) {
      var message = event.target.closest('.message');
      var src = message.querySelector('img').src;
      document.getElementById('image-dialog').elements['_id'].value = message.id;
      document.getElementById('image-dialog').elements['url'].value = src;
      document.getElementById('image-dialog').querySelector('img').src = src;
      openPopup('image-dialog');
    }
    function quicksend(event, applySetting) {
      if (event.key !== 'Enter' || event.shiftKey) return;
      if (event.ctrlKey || (applySetting && document.querySelector('#quicksend').checked)) {
        event.preventDefault();
        event.target.closest('form').querySelector('[type=submit]').click();
      }
    }
    function selectSpeaker(speaker) {
      var form = document.querySelector('#send-box')
      form.className = 'chara-bg '+speaker;
      form.elements.who.value = speaker;
    }
    function openUsernameDialog() {
      var name = prompt('What will you, the writer, be known by?');
      if (name != null) {
        RP.changeMyUsername(name);
      }
    }
    function sendMessage(event) {
      event.preventDefault();
      var args = {
        type: event.target.elements.type.value,
        who: event.target.elements.who.value,
        content: event.target.elements.content.value,
      }
      // this will modify args if we are using an OOC shortcut
      if (args.who !== 'ooc') {
        var newContent = [
          /^\({2,}\s*([\s\S]*?[^\s])\s*\)*$/g, // (( message text ))
          /^\{+\s*([\s\S]*?[^\s])\s*\}*$/g, // { message text }, {{ message text }}, ...
          /^\/\/\s*([\s\S]*[^\s])\s*$/g // //message text
        ].map(function (regex) {
          var match = regex.exec(args.content);
          if (!match) return null;
          else return match[1];
        }).find(function (match) {
          return match != null;
        });
        if (newContent) {
          args.who = 'ooc';
          args.content = newContent;
        }
      }
      RP.sendMessage(args, function() {
        event.target.querySelector('[name=content]').value = '';
        try { localStorage.removeItem('rpsettings.sendBoxText') } catch (err) {}
      });
    }
    function sendEditedMessage(event) {
      toggleEditing(event);
      event.preventDefault();
      RP.sendMessage({
        _id: event.target.elements._id.value,
        type: event.target.elements.type.value,
        who: event.target.elements.who.value,
        content: event.target.elements.content.value,
      });
    }

    function sendImage(event) {
      event.preventDefault();
      var args = {
        _id: event.target.elements._id.value || undefined,
        type: event.target.elements.type.value,
        url: event.target.elements.url.value,
      };
      RP.sendMessage(args, function() {
        event.target.reset();
        closeMe(event);
      })
    }
    
    function showHistory(event) {
      var id = event.target.closest('.message').id;
      window.open(`diff.html?id=${id}`, '_blank');
    }
  </script>
  
  <script>
    var query = {};
    location.search.substr(1).split("&").forEach(function(x) { x=x.split('='); query[x[0]] = decodeURIComponent(x[1]) });
    
    var pagenum = parseInt(query['page']) || 0;
    if (pagenum) {
      document.body.dataset.pagenum = pagenum;
      
      Array.from(document.querySelectorAll('[data-page]:not([data-page=archive])'))
      .forEach(function(el) {
        el.remove();
      })
    } else {
      selectSpeaker('narrator');
      
      Array.from(document.querySelectorAll('[data-page]:not([data-page=chat])'))
      .forEach(function(el) {
        el.remove();
      })
    }
    Array.from(document.querySelectorAll('[data-page]'))
    .forEach(function(el) {
      el.removeAttribute('data-page');
    })
  </script>

  <script>
    Array.from(document.querySelectorAll('[data-persist]'))
    .forEach(function (input) {
      var storageKey = 'rpsettings.' + input.dataset.persist;
      var inputProp = (input.type === 'checkbox') ? 'checked' : 'value';
      function onchange() {
        localStorage.setItem(storageKey, input[inputProp]);
      }
      input.addEventListener('change', onchange);
      if (input.tagName.toLowerCase() === 'textarea') {
        input.addEventListener('input', onchange);
      }
      if (localStorage.getItem(storageKey) != null) {
        if (input.type === 'checkbox') {
          input.checked = (localStorage.getItem(storageKey) === 'true');
        } else {
          input.value = localStorage.getItem(storageKey);
        }
      }
    });
  </script>

  <script>
    // This is a bunch of stuff for the auto-resizing of the textbox

    function autosizeTextarea(event, minRows, maxRows) {
      var el = event.target;
      while (el.rows > minRows && el.scrollHeight <= el.offsetHeight) {
        el.rows = el.rows - 1;
      }
      while (el.rows < maxRows && el.scrollHeight > el.offsetHeight) {
        el.rows = el.rows + 1;
      }
    }

    window.requestAnimationFrame((function update(lastHeight) {
      var el = document.querySelector('#send-box');
      if (!el) return;
      var height = el.clientHeight;
      if (height !== lastHeight) {
        document.body.style.marginBottom = (height + 30)+'px';
        window.scrollBy(0, height-lastHeight);
      }
      window.requestAnimationFrame(update.bind(null, height));
    }).bind(null, 0));
  </script>

  <script src="rp.js"></script>
  <script src="format-rp-message.js"></script>
  
  <script>
    document.getElementById('my-user-name').dataset.userid = RP.myUserID;
  </script>

  <script>
    function contrast(color) {
      var rgb = color.match(/\w\w/g).map(function(n) { return parseInt(n, 16) });
      var brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114);
      return (brightness < 128*1000) ? 'white' : 'black';
    }
    function escapeStringCSS(str) {
      return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\s/g, ' ')
    }
    function charaStyles(data) {
      var style = document.createElement('style');
      style.id = 'styles-' + data._id;
      style.innerHTML = `
        .${data._id}.chara-bg,
        .${data._id} .chara-bg {
          color: ${contrast(data.color)};
          background-color: ${data.color};
        }
        .${data._id}.chara-name::before,
        .${data._id} .chara-name::before {
          content: "${escapeStringCSS(data.name)}";
        }`
      return style;
    }
    function userStyles(data) {
      var style = document.createElement('style');
      style.id = 'styles-' + data._id;
      style.innerHTML = `
        [data-userid=${data._id}].user-name::before,
        [data-userid=${data._id}] .user-name::before {
          content: "${escapeStringCSS(data.name)}";
        }`
      return style;
    }
    function buildMessageElement(data) {
      var template = document.querySelector('template#msg-'+data.type) || document.querySelector('template#msg-unknown');
      var el = template.content.cloneNode(true).querySelector('*');
      el.id = data._id;
      el.dataset.rev = data._rev;
      el.dataset.userid = data.userid;
      if (data.userid !== RP.myUserID && el.querySelector('.edit-button')) {
        el.querySelector('.edit-button').style.display = 'none';
      } 
      if (data.type === 'text') {
        el.dataset.who = data.who;
        el.classList.add(data.who);
        el.querySelector('form [name=_id]').value = data._id;
        el.querySelector('form [name=type]').value = data.type;
        el.querySelector('form [name=who]').value = data.who;
        el.querySelector('form [name=content]').defaultValue = data.content;
        el.querySelector('blockquote').innerHTML = formatRpMessage(data.content);
      } else if (data.type === 'image') {
        el.querySelector('img').src = data.url;
      } else {
        for (var prop of Object.keys(data)) {
          var dt = document.createElement('dt');
          var dd = document.createElement('dd');
          dt.innerText = prop;
          dd.innerText = JSON.stringify(data[prop]);
          el.querySelector('dl').appendChild(dt);
          el.querySelector('dl').appendChild(dd);
        }
      }
      return el;
    }
    function buildCharaOption(data) {
      var el = document.createElement('option');
      el.id = data._id;
      el.dataset.rev = data._rev;
      el.value = data._id;
      el.innerText = data.name;
      return el;
    }
    function addTo(el, container) {
      var oldEl = document.getElementById(el.id)
      if (oldEl) {
        if (el.dataset.rev && oldEl.dataset.rev == el.dataset.rev) {
          // then just ignore the new element, it should be exactly the same
        } else {
          container.replaceChild(el, oldEl);
        }
      } else {
        container.appendChild(el);
      }
      return oldEl;
    }
  </script>
  
  <script>var rpHooks = {}</script>
  
  <script src="custom.js"></script>
  
  <script>
    RP.initialize(pagenum || 0, {
      init(data) {
        setError(null);
        document.title = data.title;
        document.getElementById('title').innerText = data.title;
        for (var user of data.users) {
          var style = userStyles(user);
          addTo(style, document.head);
        }
        for (var ch of data.charas) {
          var style = charaStyles(ch);
          addTo(style, document.head);

          var dropdown = document.querySelector('#send-box select');
          if (dropdown) {
            var el = buildCharaOption(ch);
            addTo(el, dropdown);
          }
        }
        for (var msg of data.msgs) {
          var main = document.querySelector('main');
          var el = buildMessageElement(msg);
          addTo(el, main);
          if (rpHooks.onMessage) rpHooks.onMessage(msg, el, false);
        }
        
        for (var i = 1; i <= data.pageCount; ++i) {
          var optionEl = document.createElement('option');
          optionEl.value = i;
          optionEl.innerText = `Page ${i}`;
          document.querySelector('#pager select').appendChild(optionEl);
        }
        var optionEl = document.createElement('option');
        optionEl.value = 0;
        optionEl.innerText = 'Chat';
        document.querySelector('#pager select').appendChild(optionEl);

        document.querySelector('#pager [name=page]').value = pagenum;
        
        if (pagenum === 0) {
          document.querySelector('#pager #prev-page').href = `?page=${data.pageCount}`;
        } else if (pagenum != 1) {
          document.querySelector('#pager #prev-page').href = `?page=${pagenum-1}`;
        }
        if (pagenum === data.pageCount) {
          document.querySelector('#pager #next-page').href = `?page=${0}`;
        } else if (pagenum != 0) {
          document.querySelector('#pager #next-page').href = `?page=${pagenum+1}`;
        }
        var loadingMsg = document.getElementById('loading-messages');
        if (loadingMsg) {
          loadingMsg.remove();
        }
      },
      title(title) {
        document.title = title;
        document.getElementById('title').innerText = title;
      },
      user(data) {
        var style = userStyles(data);
        addTo(style, document.head);
      },
      chara(data) {
        var style = charaStyles(data);
        addTo(style, document.head);
        
        var dropdown = document.querySelector('#send-box select');
        if (dropdown) {
          var el = buildCharaOption(data);
          var oldEl = addTo(el, dropdown);
          if (oldEl && oldEl.selected) {
            el.selected = true;
          }
        }
      },
      msg(data) {
        var wasAtBottom =
            document.documentElement.offsetHeight -
            Math.ceil(window.innerHeight + window.scrollY) < 31;
        
        var main = document.querySelector('main');
        var el = buildMessageElement(data);
        var oldEl = addTo(el, main);
        
        if (rpHooks.onMessage) rpHooks.onMessage(data, el, !oldEl);
        
        if (!oldEl) {
          if (!pagenum) {
            // only keep 10 msgs
            while (main.childNodes.length > 10) {
              main.firstChild.remove();
            }
          }
          // if we were previously at the bottom of the page, scroll back down there
          if (wasAtBottom && !pagenum) {
            window.scrollBy(0, 999999);
          }

          // we play an alert if...
          var isVisible = document.visibilityState === 'visible';
          if (!isVisible) {
            if (('alertNoise' in window) && (document.getElementById('audio-alerts') || {}).checked) { // might not have loaded yet!
              alertNoise.play();
            }
          }
        }
      },
      error(err, willRetry) {
        console.error(err);
        setError(err);
      }
    })
  </script>

  <!-- alert audio -->
  <script src="/libraries/howler.core.min.js"></script>
  <script>
    var alertNoise = new Howl({
      src: ['https://cdn.glitch.com/0e12472f-d496-485a-a042-740bef658eb2%2Ftypewriter.mp3?v=1575714187192']
    });
  </script>
  
  <script>
    RP.checkForUpdates()
    .then(function(versions) {
      alert(`New RPNow server available: ${versions.latest}`);
    });
  </script>
</body>
