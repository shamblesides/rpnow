<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>RPNow</title>
  <style>
    body {
      width: 90%;
      max-width: 700px;
      margin: 20px auto;
      box-sizing: border-box;
      text-align: center;
    }
    header aside {
      transform: translate(calc(-20vmin - 32px)) rotate(-10deg);
      text-align: center;
      margin-bottom: 0;
      font-size: calc(16px + 7vmin);
      line-height: 1;
      font-family: "Alice";
    }
    header h1 {
      margin: -2vmin 0 0;
      text-align: center;
      font-size: calc(24px + 14vmin);
      line-height: 1;
      font-family: "Playfair Display";
      font-weight: normal;
    }
    body > div > p {
      text-align: center;
    }
    details {
      text-align: left;
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
      vertical-align: top;
    }
    summary {
      padding: 15px;
    }
    summary h2, summary h3 {
      display: inline-block;
      margin: 0;
      line-height: 1;
    }
    summary a {
      color: inherit;
      border-bottom: dotted 1px;
      border-bottom-color: inherit;
    }
    #signup-form {
      margin: auto;
      width: 200px;
      text-align: center;
    }
    #top-buttons {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    #top-buttons details {
      width: 49%;
    }
    #top-buttons details > :not(summary) {
      margin-left: 20px;
      margin-right: 20px;
    }
    #top-buttons details[open] summary {
      margin-bottom: 10px;
    }
    #top-buttons details > :last-child {
      margin-bottom: 20px;
    }
    #auth-view ul {
      text-align: left;
      display: inline-block;
      width: 150px;
    }
  </style>
</head>

<body>
  <header title="Let's RPNow">
    <aside>Let's</aside>
    <h1>RPNow</h1>
  </header>

  <div id="loading-view">Loading...</div>

  <div id="auth-view" style="display:none">
    <p>The Dead-Simple Text-Based Roleplay Website</p>

    <ul>
      <li>
        <a href="/login.html?signUp">Create account</a>
      </li>
      <li>
        <a href="/login.html">Log in</a>
      </li>
    </ul>
  </div>

  <div id="dashboard-view" style="display:none">
    <p>
      You are logged in as <span id="username"></span>.
      <button type="button" onclick="handleLogout()">Log out</button>
      <div id="logout-error"></div>
    </p>

    <div id="top-buttons">
      <details>
        <summary>
          <h2>Create RP</h2>
        </summary>

        <button onclick="createRP()">
          Start from scratch
        </button>

        <p>or import a .json file:</p>

        <input type="file" name="file" accept=".json" required onchange="importRP(event)">
      </details>

      <details>
        <summary>
          <h2>Join RP</h2>
        </summary>

        <span>Here's how it works:</span>

        <ol>
          <li>Your friend creates an RP</li>
          <li>Your friend invites you to the RP</li>
          <li>
            If they have never invited you to an RP before, you will need to give them your verification code:
            <button onclick="showVerificationCode()">Get Verification Code</button>
          </li>
          <li>You refresh this page, and the RP will be here</li>
        </ol>
      </details>
    </div>

    <h2>My RPs</h2>
    <div id="rp-list"></div>
    <div id="db-loading">Loading RP list...</div>
    <div id="db-error"></div>
  </div>

  <template id="tile-template">
    <details>
      <summary>
        <a>
          <h3></h3>
        </a>
      </summary>
      <ul class="participants-list"></ul>
    </details>
  </template>

  <!-- application code -->
  <script type="text/javascript" src="https://sdk.userbase.com/2/userbase.js"></script>
  <script type="text/javascript">
    var loadingView = document.getElementById('loading-view');
    var dashboardView = document.getElementById('dashboard-view')
    var authView = document.getElementById('auth-view');

    userbase.init({ appId: '8dcdb794-f6c1-488d-966d-0058b5889c93' })
    .then(function (session) {
      if (session.user) {
        showDashboard(session.user);
      } else {
        showAuth();
      }
    })

    function showAuth() {
      dashboardView.style.display = 'none'
      loadingView.style.display = 'none'
      authView.style.display = ''
    }

    function handleLogout() {
      userbase.signOut().then(function () {
        showAuth();
      }).catch(function (err) {
        document.getElementById('logout-error').innerText = err;
      });
    }

    function showDashboard(user) {
      authView.style.display = 'none'
      loadingView.style.display = 'none';
      dashboardView.style.display = ''

      document.getElementById('username').innerText = user.username
      document.getElementById('rp-list').innerText = ''
      document.getElementById('db-loading').style.display = 'block'
      document.getElementById('db-error').innerText = ''

      userbase.getDatabases()
        .then(function (results) {
          var template = document.querySelector('template#tile-template');
          if (results.databases.length === 0) {
            document.getElementById('rp-list').innerText = "No RP's yet! Create one?"
          }
          results.databases.forEach(function (databaseMeta) {
            var id = databaseMeta.databaseId || databaseMeta.databaseName;
            var el = template.content.cloneNode(true).querySelector('*');
            el.querySelector('a').href = `/rp.html?room=${id}`;
            Object.assign(el.querySelector('summary').style, colorsForString(id))
            var h3 = el.querySelector('h3');
            try {
              h3.innerText = localStorage.getItem('rptitles.' + (id)) || '';
            } catch (err) {}
            if (!h3.innerText) {
              h3.innerText = '‚ùó Newly added RP'
            }
            var ul = el.querySelector('.participants-list')
            if (databaseMeta.isOwner) {
              var li = document.createElement('li');
              li.innerText = `You are the owner`;
              ul.appendChild(li);
            }
            if (databaseMeta.receivedFromUsername) {
              var li = document.createElement('li');
              li.innerText = `Invited by: ${databaseMeta.receivedFromUsername}`;
              ul.appendChild(li);
            }
            databaseMeta.users.forEach(function (user) {
              if (user.username === databaseMeta.receivedFromUsername) {
                return;
              }
              var li = document.createElement('li');
              li.innerText = `Participant: ${user.username}`;
              ul.appendChild(li);
            });
            // var date = entry.date && new Date(entry.date);
            // el.querySelector('.rp-date').innerText = date && date.toLocaleString();
            document.getElementById('rp-list').appendChild(el);
          });
          document.getElementById('db-loading').style.display = 'none';
          console.log(results);
        })
        .catch(function (err) {
          document.getElementById('db-error').innerText = err
          throw err;
        })
    }

    function createRP() {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: 'Untitled',
        });
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function importRP(event) {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';
      var meter = document.createElement('meter');
      loadingView.appendChild(meter)

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return new Promise(function (resolve) {
          var fr = new FileReader();
          fr.onload = function(evt) {
            resolve(this.result)
          }
          fr.readAsText(event.target.files[0]);
        })
      })
      .then(function (json) {
        var messages = JSON.parse(json);
        var meta = messages.shift();
        console.log(meta);
        console.log(messages);
        var charaIds = [];
        var idCounter = 1;
        var totalCount = messages.length + meta.charas.length;
        var progress = 0;
        function wait(value) {
          return new Promise(function (resolve) { setTimeout(resolve, 1000, value) })
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: meta.title,
        }).then(function insertCharas() {
          var batch = meta.charas.slice(0, 10).map(function (data) {
            return { name: data.name, color: data.color };
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `c-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (item, i) {
              console.log(`${batchIds[i]}   ${item.name}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: item
              }
            })
          })
          .then(function () {
            progress += batch.length / totalCount;
            meter.value = progress;
            meta.charas.splice(0, 10);
            charaIds = charaIds.concat(batchIds);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertCharas)
        }).then(function insertMessages() {
          var batch = messages.slice(0, 10).map(function (data) {
            return (data.type === 'image') ? {
              type: 'image',
              url: data.url,
            } : {
              type: 'text',
              who: ['narrator','ooc'].includes(data.type) ? data.type : charaIds[data.charaId],
              content: data.content,
            }
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `m-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (msg, i) {
              console.log(`${batchIds[i]}   ${msg.type} ${msg.who}    ${msg.content || msg.url}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: msg
              }
            })
          })
          .then(function () {
            progress += batch.length / totalCount;
            meter.value = progress;
            messages.splice(0, 10);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertMessages)
        })
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function showVerificationCode() {
      userbase.getVerificationMessage()
      .then(function (result) {
        console.log(result)
        prompt('Copy this code and send it to your friend.', result.verificationMessage);
      })
      .catch(function (err) {
        alert(err);
      })
    }

    function djb2(str){
      var hash = 5381;
      for (var i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
      }
      return hash;
    }

    function colorsForString(str) {
      // hash id into 32-bit integer
      var hash = djb2(str.split('').reverse().join(''));

      var rgb = [0,8,16].map(function (shift) {
        return hash >> shift & 255;
      })
      var r = rgb[0];
      var g = rgb[1];
      var b = rgb[2];

      var light = (r*299)+(g*587)+(b*114) > 128000;

      return {
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        color: light? 'black':'white'
      }
    }
  </script>
</body>
</html>
