<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>RPNow</title>
  <style>
    body {
      width: 90%;
      max-width: 700px;
      margin: 20px auto;
      box-sizing: border-box;
    }
    .pane {
      display: inline-block;
      border: solid 1px rgba(0,0,0,0.5);
      background: none;
      font-size: inherit;
      font-family: inherit;
      cursor: pointer;
      margin: 0 5px 10px;
      text-decoration: none;
      color: inherit;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      word-break: break-all;
    }
    .pane.button {
      height: 60px;
      width: 290px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .pane.rp {
      display: inline-flex;
      flex-direction: column;
      min-height: 140px;
      width: 290px;
    }
    .pane.rp header {
      padding: 10px;
      margin: 0;
      position: relative;
    }
    details {
      border: solid 1px black;
      box-sizing: border-box;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
      vertical-align: top;
    }
    summary {
      padding: 15px;
    }
    summary h1, summary h3 {
      display: inline-block;
      margin: 0;
      line-height: 1;
    }
    summary a {
      color: inherit;
      border-bottom: dotted 1px;
      border-bottom-color: inherit;
    }
  </style>
</head>

<body>
  <div id="loading-view">Loading...</div>

  <div id="auth-view" style="display:none">
    <h1>Login</h1>
    <form id="login-form">
      <input name="username" type="text" required placeholder="Username">
      <input name="password" type="password" required placeholder="Password">
      <input type="submit" value="Sign in">
    </form>
    <div id="login-error"></div>

    <h1>Create an account</h1>
    <form id="signup-form">
      <input name="username" type="text" required placeholder="Username">
      <input name="password" type="password" required placeholder="Password">
      <input type="submit" value="Create an account">
    </form>
    <div id="signup-error"></div>
  </div>

  <div id="dashboard-view" style="display:none">
    <div id="username"></div>
    <button type="button" onclick="handleLogout()">Logout</button>
    <div id="logout-error"></div>

    <details style="display: inline-block; width: 45%;">
      <summary>
        <h1>Create RP</h1>
      </summary>

      <button onclick="createRP()">
        Start from scratch
      </button>

      <p>or import a .json file:</p>

      <input type="file" name="file" accept=".json" required onchange="importRP(event)">
    </details>

    <details style="display: inline-block; width: 45%;">
      <summary>
        <h1>Join RP</h1>
      </summary>

      <p>Here's how it works:</p>
      <ol>
        <li>Your friend creates an RP</li>
        <li>Your friend invites you to the RP</li>
        <li>
          If they have never invited you to an RP before, you will need to give them your verification code:
          <button onclick="showVerificationCode()">Get Verification Code</button>
        </li>
        <li>You refresh this page, and the RP will be here</li>
      </ol>
    </details>

    <h1>My RPs</h1>
    <div id="rp-list"></div>
    <div id="db-loading">Loading RP list...</div>
    <div id="db-error"></div>
  </div>

  <template id="tile-template">
    <details>
      <summary>
        <a>
          <h3></h3>
        </a>
      </summary>
      <ul class="participants-list"></ul>
    </details>
  </template>

  <!-- application code -->
  <script type="text/javascript" src="https://sdk.userbase.com/2/userbase.js"></script>
  <script type="text/javascript">
    var loadingView = document.getElementById('loading-view');
    var dashboardView = document.getElementById('dashboard-view')
    var authView = document.getElementById('auth-view');

    userbase.init({ appId: '8dcdb794-f6c1-488d-966d-0058b5889c93' })
    .then(function (session) {
      loadingView.style.display = 'none';
      if (session.user) {
        showDashboard(session.user);
      } else {
        authView.style.display = '';
      }
    })

    document.getElementById('login-form').addEventListener('submit', handleLogin.bind(null, 'signIn'))
    document.getElementById('signup-form').addEventListener('submit', handleLogin.bind(null, 'signUp'))
    

    function showAuth() {
      document.getElementById('dashboard-view').style.display = 'none'
      document.getElementById('loading-view').style.display = 'none'
      document.getElementById('auth-view').style.display = ''

      document.getElementById('login-form').reset();
      document.getElementById('signup-form').reset();
      document.getElementById('login-error').innerText = ''
      document.getElementById('signup-error').innerText = ''
    }

    function handleLogin(method, e) {
      e.preventDefault()

      var form = e.target;
      var errorText = form.nextElementSibling;
      errorText.innerText = '';

      const username = form.elements.username.value;
      const password = form.elements.password.value;

      userbase[method]({ username, password, rememberMe: 'local' })
        .then(showDashboard)
        .catch(function (err) { errorText.innerText = err })
    }

    function handleLogout() {
      userbase.signOut().then(function () {
        showAuth();
      }).catch(function (err) {
        document.getElementById('logout-error').innerText = err;
      });
    }

    function showDashboard(user) {
      document.getElementById('auth-view').style.display = 'none'
      document.getElementById('dashboard-view').style.display = ''

      document.getElementById('username').innerText = user.username
      document.getElementById('rp-list').innerText = ''
      document.getElementById('db-loading').style.display = 'block'
      document.getElementById('db-error').innerText = ''

      userbase.getDatabases()
        .then(function (results) {
          var template = document.querySelector('template#tile-template');
          if (results.databases.length === 0) {
            document.getElementById('rp-list').innerText = "No RP's yet! Create one?"
          }
          results.databases.forEach(function (databaseMeta) {
            var id = databaseMeta.databaseId || databaseMeta.databaseName;
            var el = template.content.cloneNode(true).querySelector('*');
            el.querySelector('a').href = `/rp.html?room=${id}`;
            Object.assign(el.querySelector('summary').style, colorsForString(id))
            var h3 = el.querySelector('h3');
            try {
              h3.innerText = localStorage.getItem('rptitles.' + (id)) || '';
            } catch (err) {}
            if (!h3.innerText) {
              h3.innerText = `RP #${id}`
            }
            var ul = el.querySelector('.participants-list')
            if (databaseMeta.isOwner) {
              var li = document.createElement('li');
              li.innerText = `You are the owner`;
              ul.appendChild(li);
            }
            if (databaseMeta.receivedFromUsername) {
              var li = document.createElement('li');
              li.innerText = `Invited by: ${databaseMeta.receivedFromUsername}`;
              ul.appendChild(li);
            }
            databaseMeta.users.forEach(function (user) {
              if (user.username === databaseMeta.receivedFromUsername) {
                return;
              }
              var li = document.createElement('li');
              li.innerText = `Participant: ${user.username}`;
              ul.appendChild(li);
            });
            // var date = entry.date && new Date(entry.date);
            // el.querySelector('.rp-date').innerText = date && date.toLocaleString();
            document.getElementById('rp-list').appendChild(el);
          });
          document.getElementById('db-loading').style.display = 'none';
          console.log(results);
        })
        .catch(function (err) {
          document.getElementById('db-error').innerText = err
          throw err;
        })
    }

    function createRP() {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: 'Untitled',
        });
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function importRP(event) {
      dashboardView.style.display = 'none';
      loadingView.style.display = '';
      var meter = document.createElement('meter');
      loadingView.appendChild(meter)

      var rpid = `rp-${Date.now().toString(36)}`;

      var isEmpty = null;
      userbase.openDatabase({
        databaseName: rpid,
        changeHandler(items) {
          isEmpty = (items.length === 0);
        }
      })
      .then(function () {
        if (isEmpty !== true) {
          throw new Error(`Failed to create RP: hasItems === ${isEmpty}`);
        }
        return new Promise(function (resolve) {
          var fr = new FileReader();
          fr.onload = function(evt) {
            resolve(this.result)
          }
          fr.readAsText(event.target.files[0]);
        })
      })
      .then(function (json) {
        var messages = JSON.parse(json);
        var meta = messages.shift();
        console.log(meta);
        console.log(messages);
        var charaIds = [];
        var idCounter = 1;
        var totalCount = messages.length + meta.charas.length;
        var progress = 0;
        function wait(value) {
          return new Promise(function (resolve) { setTimeout(resolve, 1000, value) })
        }
        return userbase.insertItem({
          databaseName: rpid,
          itemId: 'title',
          item: meta.title,
        }).then(function insertCharas() {
          var batch = meta.charas.slice(0, 10).map(function (data) {
            return { name: data.name, color: data.color };
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `c-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (item, i) {
              console.log(`${batchIds[i]}   ${item.name}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: item
              }
            })
          })
          .then(function () {
            progress += batch.length / totalCount;
            meter.value = progress;
            meta.charas.splice(0, 10);
            charaIds = charaIds.concat(batchIds);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertCharas)
        }).then(function insertMessages() {
          var batch = messages.slice(0, 10).map(function (data) {
            return (data.type === 'image') ? {
              type: 'image',
              url: data.url,
            } : {
              type: 'text',
              who: ['narrator','ooc'].includes(data.type) ? data.type : charaIds[data.charaId],
              content: data.content,
            }
          })
          if (batch.length === 0) return;
          var batchIds = batch.map(function () {
            return `m-${(idCounter++).toString(36).padStart(26, 0)}`;
          })
          return userbase.putTransaction({
            databaseName: rpid,
            operations: batch.map(function (msg, i) {
              console.log(`${batchIds[i]}   ${msg.type} ${msg.who}    ${msg.content || msg.url}`);
              return {
                command: 'Insert',
                itemId: batchIds[i],
                item: msg
              }
            })
          })
          .then(function () {
            progress += batch.length / totalCount;
            meter.value = progress;
            messages.splice(0, 10);
          })
          .catch(function (err) {
            if (err.name !== 'TooManyRequests') throw err;
          })
          .then(wait)
          .then(insertMessages)
        })
      })
      .then(function () {
        window.location.href = `/rp.html?room=${rpid}`;
      })
      .catch(function (err) {
        alert(err.message);
        throw err;
      })
    }

    function showVerificationCode() {
      userbase.getVerificationMessage()
      .then(function (result) {
        console.log(result)
        prompt('Copy this code and send it to your friend.', result.verificationMessage);
      })
      .catch(function (err) {
        alert(err);
      })
    }

    function djb2(str){
      var hash = 5381;
      for (var i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i); /* hash * 33 + c */
      }
      return hash;
    }

    function colorsForString(str) {
      // hash id into 32-bit integer
      var hash = djb2(str.split('').reverse().join(''));

      var rgb = [0,8,16].map(function (shift) {
        return hash >> shift & 255;
      })
      var r = rgb[0];
      var g = rgb[1];
      var b = rgb[2];

      var light = (r*299)+(g*587)+(b*114) > 128000;

      return {
        backgroundColor: `rgb(${r}, ${g}, ${b})`,
        color: light? 'black':'white'
      }
    }
  </script>
</body>
</html>
